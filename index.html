<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteveSystem - Master Control Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --card-bg: #2a2a2a;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border-color: #404040;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
        }
        
        .dashboard-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-active { background-color: var(--accent-green); }
        .status-warning { background-color: var(--accent-yellow); }
        .status-error { background-color: var(--accent-red); }
        .status-neutral { background-color: var(--text-secondary); }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
            transition: width 0.5s ease;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), #1d4ed8);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .input-field {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            width: 100%;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .voice-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
        }
        
        .thermometer {
            width: 20px;
            height: 100px;
            background: linear-gradient(to top, var(--accent-red) 0%, var(--accent-yellow) 50%, var(--accent-green) 100%);
            border-radius: 10px;
            position: relative;
        }
        
        .thermometer::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--secondary-bg);
            border-radius: 10px;
            transition: height 0.5s ease;
        }
        
        .grid-auto {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <!-- Loading Barrier - Blocks UI until data is ready -->
    <div id="loading-barrier" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column;">
        <div class="text-center">
            <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center mx-auto mb-4 animate-pulse">
                <i class="fas fa-chart-line text-white text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Loading Trading Data...</h2>
            <p class="text-gray-400">Preparing your complete dashboard</p>
            <div class="mt-4 w-64 bg-gray-700 rounded-full h-2">
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full animate-pulse" style="width: 100%"></div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-black/50 backdrop-blur-md border-b border-gray-800 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-green-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-brain text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">SteveSystem</h1>
                        <p class="text-sm text-gray-400">Meta Content Orchestrator</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <button onclick="window.location.href='launch.html'" class="btn-primary flex items-center">
                        <i class="fas fa-home mr-2"></i>Launcher
                    </button>
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Session</div>
                        <div class="font-mono text-green-400" id="session-time"></div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-400">BSI Status</div>
                        <div class="flex items-center">
                            <span class="status-indicator status-warning"></span>
                            <span id="bsi-status">6.6 - Re-path Active</span>
                        </div>
                    </div>
                    <img class="w-12 h-12 rounded-full object-cover" src="assets/profile.png" alt="Profile">
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-8">
        
        <!-- Capital & Priorities Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            
            <!-- Capital Tracker -->
            <div class="dashboard-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fas fa-dollar-sign text-green-400 mr-3"></i>
                        Daily Capital
                    </h2>
                <div class="flex items-center space-x-3">
                    <button class="text-sm text-gray-400 hover:text-white" onclick="prevDay()" title="Previous Day">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="text-sm font-semibold cursor-pointer hover:text-blue-400" 
                          id="current-day-display" 
                          onclick="jumpToToday()" 
                          title="Click to jump to today">Today</span>
                    <button id="nextDayBtn" class="text-sm text-gray-400 hover:text-white" onclick="nextDay()" title="Next Day">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button class="btn-primary text-sm" onclick="editCurrentDay()">
                        <i class="fas fa-edit mr-2"></i>Edit Day
                    </button>
                </div>
                </div>
                <div class="text-center mb-6">
                    <div class="metric-value" id="capital-value">$10,000</div>
                    <div class="text-sm text-gray-400">Current Bankroll</div>
                    <div class="flex justify-center items-center mt-2">
                        <span id="capital-change" class="text-green-400 text-lg font-semibold">
                            <i class="fas fa-arrow-up mr-1"></i>+$250 (2.5%)
                        </span>
                    </div>
                </div>
                <div class="bg-secondary-bg rounded-lg p-4">
                    <canvas id="capitalChart" height="150"></canvas>
                </div>
            </div>

            <!-- Top Priorities -->
            <div class="dashboard-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fas fa-star text-yellow-400 mr-3"></i>
                        Top Priorities
                    </h2>
                    <div class="flex items-center space-x-3">
                        <button class="text-sm text-gray-400 hover:text-white" onclick="prevPriorityDay()" title="Previous Day">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="text-sm font-semibold cursor-pointer hover:text-blue-400" 
                              id="priority-day-display" 
                              onclick="jumpPriorityToToday()" 
                              title="Click to jump to today">Today</span>
                        <button id="nextPriorityBtn" class="text-sm text-gray-400 hover:text-white" onclick="nextPriorityDay()" title="Next Day">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    <button class="btn-primary text-sm" onclick="openEditPrioritiesModal()">
                        <i class="fas fa-edit mr-2"></i>Manage
                    </button>
                        <button class="btn-primary text-sm bg-green-600 hover:bg-green-700" onclick="openEditPrioritiesModal()">
                            <i class="fas fa-plus mr-2"></i>Add
                    </button>
                </div>
                    </div>
                <div class="space-y-4" id="priorities-list">
                    <!-- Priorities will be rendered here -->
                    </div>
                <div class="mt-4 text-sm text-gray-400 text-center" id="priority-status">
                    <!-- Priority completion status will show here -->
                </div>
            </div>
        </div>

        <!-- PNL Monthly Calendar -->
        <div class="dashboard-card mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold flex items-center">
                    <i class="fas fa-calendar-alt text-blue-400 mr-3"></i>
                    Monthly PNL Calendar
                </h2>
                <div class="flex items-center space-x-4">
                    <button class="btn-primary text-sm" onclick="showImportModal()">
                        <i class="fas fa-upload mr-2"></i>Import Bet Slips
                    </button>
                    <button class="btn-primary text-sm" onclick="exportData()">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button class="btn-primary text-sm bg-yellow-600 hover:bg-yellow-700" onclick="debugShowAllData()">
                        <i class="fas fa-bug mr-2"></i>Debug
                    </button>
                    <button class="text-sm text-gray-400 hover:text-white" onclick="prevMonth()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="text-sm font-semibold" id="current-month">October 2025</span>
                    <button class="text-sm text-gray-400 hover:text-white" onclick="nextMonth()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                <div class="text-center p-4 bg-secondary-bg rounded-lg">
                    <div class="text-sm text-gray-400">Month Total</div>
                    <div class="text-3xl font-bold text-green-400">+$1,250</div>
                    <div class="text-xs text-gray-500 mt-1">12.5% Growth</div>
                </div>
                <div class="text-center p-4 bg-secondary-bg rounded-lg">
                    <div class="text-sm text-gray-400">Wins / Losses</div>
                    <div class="text-2xl font-bold">
                        <span class="text-green-400">18</span>
                        <span class="text-gray-500"> / </span>
                        <span class="text-red-400">7</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">72% Win Rate</div>
                </div>
                <div class="text-center p-4 bg-secondary-bg rounded-lg">
                    <div class="text-sm text-gray-400">Avg Win</div>
                    <div class="text-2xl font-bold text-purple-400">$125</div>
                    <div class="text-xs text-gray-500 mt-1">Per winning day</div>
                </div>
                <div class="text-center p-4 bg-secondary-bg rounded-lg">
                    <div class="text-sm text-gray-400">Best Day</div>
                    <div class="text-2xl font-bold text-blue-400">$250</div>
                    <div class="text-xs text-gray-500 mt-1">Oct 30</div>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="bg-secondary-bg rounded-lg p-4">
                <!-- Weekday Headers -->
                <div class="grid grid-cols-7 gap-2 mb-2">
                    <div class="text-center text-xs font-semibold text-gray-400 py-2">SUN</div>
                    <div class="text-center text-xs font-semibold text-gray-400 py-2">MON</div>
                    <div class="text-center text-xs font-semibold text-gray-400 py-2">TUE</div>
                    <div class="text-center text-xs font-semibold text-gray-400 py-2">WED</div>
                    <div class="text-center text-xs font-semibold text-gray-400 py-2">THU</div>
                    <div class="text-center text-xs font-semibold text-gray-400 py-2">FRI</div>
                    <div class="text-center text-xs font-semibold text-gray-400 py-2">SAT</div>
                </div>
                
                <!-- Calendar Days -->
                <div class="grid grid-cols-7 gap-2" id="calendar-grid">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- BSI Scale & Thermometer Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <!-- BSI Scale -->
            <div class="dashboard-card">
                <h2 class="text-xl font-bold flex items-center mb-4">
                    <i class="fas fa-chart-line text-blue-400 mr-3"></i>
                    BSI Scale
                </h2>
                <div class="text-center mb-4">
                    <div class="metric-value">6.6</div>
                    <div class="text-sm text-gray-400">Current BSI Score</div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Symbolic Alignment</span>
                        <span class="font-bold">6.5</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 65%"></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Belief Intensity</span>
                        <span class="font-bold">7.2</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 72%"></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Narrative Breathability</span>
                        <span class="font-bold text-red-400">5.9</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 59%"></div>
                    </div>
                </div>
            </div>

            <!-- Soros Alignment Thermometer -->
            <div class="dashboard-card">
                <h2 class="text-xl font-bold flex items-center mb-4">
                    <i class="fas fa-thermometer-half text-green-400 mr-3"></i>
                    Soros Alignment
                </h2>
                <div class="flex items-center justify-center h-32">
                    <div class="thermometer" id="soros-thermometer"></div>
                    <div class="ml-4">
                        <div class="metric-value text-2xl">73°</div>
                        <div class="text-sm text-gray-400">Reflexivity Index</div>
                        <div class="text-xs text-yellow-400 mt-2">Moderate Alignment</div>
                    </div>
                </div>
            </div>

            <!-- Re-path Status -->
            <div class="dashboard-card">
                <h2 class="text-xl font-bold flex items-center mb-4">
                    <i class="fas fa-route text-yellow-400 mr-3"></i>
                    Re-path Status
                </h2>
                <div class="space-y-3">
                    <div class="bg-yellow-900/30 border border-yellow-500/50 rounded-lg p-3">
                        <div class="text-yellow-300 font-semibold">LOW BSI DETECTED</div>
                        <div class="text-sm text-gray-300">Re-path Protocol Active</div>
                    </div>
                    <div class="text-sm space-y-2">
                        <div class="flex items-center">
                            <i class="fas fa-eye text-blue-400 mr-2"></i>
                            Eyes Never Lie Check
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-anchor text-green-400 mr-2"></i>
                            Reality Anchor Prompt
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-history text-purple-400 mr-2"></i>
                            Historical Case Reference
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voices & Analysis Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            
            <!-- Skitz Voices -->
            <div class="dashboard-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fas fa-users text-purple-400 mr-3"></i>
                        Skitz Voices
                    </h2>
                    <button class="btn-primary" onclick="generateVoices()">
                        <i class="fas fa-microphone mr-2"></i>Generate
                    </button>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center p-3 bg-gray-800/50 rounded-lg">
                        <div class="voice-avatar">S</div>
                        <div class="flex-1">
                            <div class="font-semibold">Skeptical Voice</div>
                            <div class="text-sm text-gray-400">Authenticity: 6.8/10</div>
                        </div>
                        <button class="text-blue-400 hover:text-blue-300">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                    <div class="flex items-center p-3 bg-gray-800/50 rounded-lg">
                        <div class="voice-avatar">O</div>
                        <div class="flex-1">
                            <div class="font-semibold">Optimistic Voice</div>
                            <div class="text-sm text-gray-400">Authenticity: 7.2/10</div>
                        </div>
                        <button class="text-blue-400 hover:text-blue-300">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                    <div class="flex items-center p-3 bg-gray-800/50 rounded-lg">
                        <div class="voice-avatar">A</div>
                        <div class="flex-1">
                            <div class="font-semibold">Analytical Voice</div>
                            <div class="text-sm text-gray-400">Authenticity: 6.4/10</div>
                        </div>
                        <button class="text-blue-400 hover:text-blue-300">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Skincrawler -->
            <div class="dashboard-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fas fa-spider text-orange-400 mr-3"></i>
                        Skincrawler
                    </h2>
                    <span class="text-sm text-gray-400">Historical Analysis</span>
                </div>
                <div class="space-y-3">
                    <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-3">
                        <div class="font-semibold text-blue-300">Pattern Match Found</div>
                        <div class="text-sm text-gray-300">Power vs Technique: 65% accuracy</div>
                    </div>
                    <div class="bg-green-900/30 border border-green-500/50 rounded-lg p-3">
                        <div class="font-semibold text-green-300">Mental Game Emphasis</div>
                        <div class="text-sm text-gray-300">Historical accuracy: 78%</div>
                    </div>
                    <div class="text-sm space-y-2">
                        <div class="flex justify-between">
                            <span>Precedent Accuracy</span>
                            <span class="font-bold">72%</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Similar Cases</span>
                            <span class="font-bold">14</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expression Constraint Analysis -->
        <div class="grid grid-cols-1 gap-6 mb-8">
            <div class="dashboard-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fas fa-sitemap text-teal-400 mr-3"></i>
                        Expression Constraint Analysis
                    </h2>
                    <span class="text-sm text-gray-400">From Read to Position Architecture</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                    <!-- 1. Reads -->
                    <div class="space-y-2">
                        <h3 class="font-bold text-lg text-gray-300">1. READS</h3>
                        <p class="text-sm text-gray-400">Quality Signal Generation</p>
                        <ul class="text-xs list-disc list-inside space-y-1 pl-1">
                            <li>Tag read with confidence (A/B/C)</li>
                            <li>A-Reads: Standalone + Parlay</li>
                            <li>B-Reads: Parlay-only</li>
                            <li>C-Reads: Pass / explore</li>
                        </ul>
                    </div>
                    <!-- 2. Expressions -->
                    <div class="space-y-2">
                        <h3 class="font-bold text-lg text-gray-300">2. EXPRESSIONS</h3>
                        <p class="text-sm text-gray-400">Position Architecture</p>
                        <ul class="text-xs list-disc list-inside space-y-1 pl-1">
                            <li>Single: High-conviction</li>
                            <li>Parlay: Narrative correlation</li>
                            <li>Live: Developing situations</li>
                            <li>Hedge: Thesis shifts</li>
                        </ul>
                    </div>
                    <!-- 3. Sizing -->
                    <div class="space-y-2">
                        <h3 class="font-bold text-lg text-gray-300">3. SIZING</h3>
                        <p class="text-sm text-gray-400">Capital Efficiency</p>
                        <ul class="text-xs list-disc list-inside space-y-1 pl-1">
                            <li>Kelly-style allocation</li>
                            <li>Independence mapping</li>
                            <li>Liquidity management</li>
                        </ul>
                    </div>
                    <!-- 4. Execution -->
                    <div class="space-y-2">
                        <h3 class="font-bold text-lg text-gray-300">4. EXECUTION</h3>
                        <p class="text-sm text-gray-400">Systematic Implementation</p>
                        <ul class="text-xs list-disc list-inside space-y-1 pl-1">
                            <li>Pre-match expression map</li>
                            <li>Live adjustment protocols</li>
                            <li>Post-result analysis</li>
                        </ul>
                    </div>
                    <!-- 5. Results -->
                    <div class="space-y-2">
                        <h3 class="font-bold text-lg text-gray-300">5. RESULTS</h3>
                        <p class="text-sm text-gray-400">Constraint Identification</p>
                        <ul class="text-xs list-disc list-inside space-y-1 pl-1">
                            <li>Track Read Accuracy vs. Expression ROI</li>
                            <li>Identify underexploited edges</li>
                            <li>Measure asymmetry capture rate</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Integration & Public Analysis Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 lg:items-start gap-6 mb-8">
            
            <!-- Trading Dashboard -->
            <div class="dashboard-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fas fa-chart-bar text-green-400 mr-3"></i>
                        Trading Dashboard
                    </h2>
                    <button class="btn-primary" onclick="openDashboard()">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Pre-Bet Commitment</span>
                        <span class="status-indicator status-warning"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Pressure Scanner</span>
                        <span class="status-indicator status-active"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Breath Tracker</span>
                        <span class="status-indicator status-neutral"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm">Human Intelligence</span>
                        <span class="status-indicator status-active"></span>
                    </div>
                </div>
            </div>

            <!-- Public Sentiment -->
            <div class="dashboard-card">
                <h2 class="text-xl font-bold flex items-center mb-4">
                    <i class="fas fa-globe text-cyan-400 mr-3"></i>
                    Public Analysis
                </h2>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-sm">Market Sentiment</span>
                        <span class="text-red-400 font-bold">Bearish</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm">Social Media Buzz</span>
                        <span class="text-yellow-400 font-bold">High</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm">Expert Consensus</span>
                        <span class="text-blue-400 font-bold">Split</span>
                    </div>
                    <div class="relative h-24 mt-4">
                        <canvas id="sentiment-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Historical Cases -->
            <div class="dashboard-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fas fa-archive text-gray-400 mr-3"></i>
                        Historical Cases
                    </h2>
                    <span class="text-sm text-gray-400">1 Case</span>
                </div>
                <div class="space-y-3">
                    <div class="bg-red-900/30 border border-red-500/50 rounded-lg p-3">
                        <div class="font-semibold text-red-300">Low BSI Reference</div>
                        <div class="text-sm text-gray-300">Anisimova vs Sabalenka</div>
                        <div class="text-xs text-red-400 mt-1">Eyes Never Lie Lesson</div>
                    </div>
                    <button class="w-full text-left text-sm text-blue-400 hover:text-blue-300">
                        <i class="fas fa-plus mr-2"></i>View All Cases
                    </button>
                </div>
            </div>
        </div>

        <!-- System Status Footer -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="dashboard-card">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400">✓</div>
                    <div class="text-sm text-gray-400">Contra Active</div>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="text-center">
                    <div class="text-2xl font-bold text-yellow-400">⚠</div>
                    <div class="text-sm text-gray-400">BSI Low</div>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400">🎤</div>
                    <div class="text-sm text-gray-400">Voices Ready</div>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-400">📊</div>
                    <div class="text-sm text-gray-400">Dashboard Live</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Single Entry Point - The ONLY initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 PAGE LOADED - Starting data initialization');
            
            // Start the ONE data flow
            window.pnlManager.initialize();
            
            // Initialize session time (non-data related)
            updateSessionTime();
            setInterval(updateSessionTime, 1000);
            
            // Fallback: Ensure calendar renders after a delay
            setTimeout(() => {
                if (window.pnlManager && window.pnlManager.data) {
                    console.log('🔄 Fallback: Rendering calendar after delay');
                    window.pnlManager.renderCalendar();
                }
            }, 1000);
        });

        function updateSessionTime() {
            document.getElementById('session-time').textContent = new Date().toLocaleTimeString();
        }

        function updateThermometer(value) {
            const thermometer = document.getElementById('soros-thermometer');
            const fillHeight = 100 - value;
            thermometer.style.setProperty('--fill-height', fillHeight + '%');
        }

        function initSentimentChart() {
            const ctx = document.getElementById('sentiment-chart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative', 'Neutral'],
                    datasets: [{
                        data: [30, 45, 25],
                        backgroundColor: ['#10b981', '#ef4444', '#6b7280'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        let capitalChartInstance = null;

        async function initCapitalChart() {
            const ctx = document.getElementById('capitalChart').getContext('2d');
            capitalChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Capital',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#a1a1aa' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#a1a1aa' }
                        }
                    }
                }
            });
            await updateCapitalChart();
        }

        async function updateCapitalChart() {
            if (!capitalChartInstance) return;
            
            console.log('=== CAPITAL CHART DEBUG ===');
            
            // Get all days in the current month to match monthly calendar
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            const labels = [];
            const data = [];
            let runningTotal = 10000; // Starting capital
            
            // Show all days in the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = await PNLManager.getDay(currentYear, currentMonth, day);
                const date = new Date(currentYear, currentMonth, day);
                const dayOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()];
                const monthDay = `${date.getMonth() + 1}/${date.getDate()}`;
                
                labels.push(`${dayOfWeek} ${monthDay}`);
                
                if (dayData.pnl) {
                    runningTotal += dayData.pnl;
                    console.log(`Day ${day}: PNL ${dayData.pnl}, Running Total: ${runningTotal}`);
                }
                data.push(runningTotal);
            }
            
            console.log('Final running total for graph:', runningTotal);
            console.log('Days processed:', daysInMonth);
            console.log('Data points:', data.length);
            console.log('========================');
            
            capitalChartInstance.data.labels = labels;
            capitalChartInstance.data.datasets[0].data = data;
            capitalChartInstance.update();
            
            // Update current capital display
            document.getElementById('capital-value').textContent = '$' + runningTotal.toLocaleString();
        }

        // Dashboard functions
        function updateDayDisplay() {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            currentViewDate.setHours(0, 0, 0, 0);
            
            const displayEl = document.getElementById('current-day-display');
            const nextBtn = document.getElementById('nextDayBtn');
            
            const isToday = currentViewDate.getTime() === today.getTime();
            
            if (isToday) {
                displayEl.textContent = 'Today';
                displayEl.className = 'text-sm font-semibold text-blue-400';
                // Disable next button if viewing today
                if (nextBtn) {
                    nextBtn.disabled = true;
                    nextBtn.className = 'text-sm text-gray-600 cursor-not-allowed';
                }
            } else {
                const dayOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][currentViewDate.getDay()];
                displayEl.textContent = `${dayOfWeek}, ${monthNames[currentViewDate.getMonth()]} ${currentViewDate.getDate()}`;
                displayEl.className = 'text-sm font-semibold cursor-pointer hover:text-blue-400';
                // Enable next button if not viewing today
                if (nextBtn) {
                    nextBtn.disabled = false;
                    nextBtn.className = 'text-sm text-gray-400 hover:text-white';
                }
            }
            
            // Load data for the current view date
            const dayData = PNLManager.getDay(currentViewDate.getFullYear(), currentViewDate.getMonth(), currentViewDate.getDate());
            
            // Update capital display
            if (dayData.pnl && dayData.pnl !== 0) {
                const changeEl = document.getElementById('capital-change');
                if (dayData.pnl > 0) {
                    changeEl.className = 'text-green-400 text-lg font-semibold';
                    changeEl.innerHTML = `<i class="fas fa-arrow-up mr-1"></i>+$${Math.abs(dayData.pnl)} PNL`;
                } else {
                    changeEl.className = 'text-red-400 text-lg font-semibold';
                    changeEl.innerHTML = `<i class="fas fa-arrow-down mr-1"></i>-$${Math.abs(dayData.pnl)} PNL`;
                }
            } else {
                const changeEl = document.getElementById('capital-change');
                changeEl.className = 'text-gray-400 text-lg font-semibold';
                changeEl.innerHTML = 'No trades recorded';
            }
        }

        async function prevDay() {
            const newDate = new Date(currentViewDate);
            newDate.setDate(newDate.getDate() - 1);
            currentViewDate = newDate;
            console.log('Previous capital day:', currentViewDate.toDateString());
            updateDayDisplay();
            await updateCapitalChart();
        }

        async function nextDay() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const newDate = new Date(currentViewDate);
            newDate.setDate(newDate.getDate() + 1);
            newDate.setHours(0, 0, 0, 0);
            
            console.log('Current view:', currentViewDate.toDateString());
            console.log('New date:', newDate.toDateString());
            console.log('Can advance?', newDate.getTime() <= today.getTime());
            
            // Don't go beyond today
            if (newDate.getTime() <= today.getTime()) {
                currentViewDate = newDate;
                console.log('✓ Advanced to:', currentViewDate.toDateString());
                updateDayDisplay();
                await updateCapitalChart();
            } else {
                console.log('✗ Already viewing today - button should be disabled');
            }
        }

        async function jumpToToday() {
            currentViewDate = new Date();
            currentViewDate.setHours(0, 0, 0, 0);
            console.log('Jump to today:', currentViewDate.toDateString());
            updateDayDisplay();
            await updateCapitalChart();
        }

        function editCurrentDay() {
            // Set the calendar to the current view date's month/year
            currentYear = currentViewDate.getFullYear();
            currentMonth = currentViewDate.getMonth();
            // Sync priorities to this day
            currentPriorityDate = new Date(currentViewDate);
            renderPriorities();
            // Open the modal for the currently viewed day
            openDayModal(currentViewDate.getDate());
        }

        function updateCapital() {
            const newValue = prompt('Enter new capital amount:', '10000');
            if (newValue && !isNaN(newValue)) {
                document.getElementById('capital-value').textContent = '$' + parseFloat(newValue).toLocaleString();
                alert('Capital updated!');
            }
        }

        window.renderPriorities = async function() {
            const container = document.getElementById('priorities-list');
            
            if (!container) {
                console.error('Priorities container not found!');
                return;
            }
            
            // Update day display
            updatePriorityDayDisplay();
            
            console.log('Rendering priorities for date:', currentPriorityDate.toDateString());
            
            // Get day data to see what priorities were worked on THIS specific day
            const dayData = PNLManager.getDay(
                currentPriorityDate.getFullYear(), 
                currentPriorityDate.getMonth(), 
                currentPriorityDate.getDate()
            );
            const dayPriorities = dayData.priorities || [];
            
            console.log('Priorities for this day:', dayPriorities);
            
            // If no priorities for this day, show empty state
            if (dayPriorities.length === 0) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                currentPriorityDate.setHours(0, 0, 0, 0);
                
                const isToday = currentPriorityDate.getTime() === today.getTime();
                const isFuture = currentPriorityDate.getTime() > today.getTime();
                
                let message = '';
                if (isFuture) {
                    message = 'Future day - no priorities yet';
                } else if (isToday) {
                    message = 'No priorities for today yet. Click "Manage" to add some.';
                } else {
                    message = 'No priorities for this day';
                }
                
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-400 text-sm">
                        ${message}
                    </div>
                `;
                return;
            }
            
            // Use the day-specific priorities directly
            const priorities = dayPriorities;
            
            // If no priorities found, show empty state
            if (priorities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-400 text-sm">
                        No priorities worked on this day
                    </div>
                `;
                return;
            }
            
            console.log('Day priorities:', priorities);
            
            const colorSchemes = [
                { bg: 'rgba(59, 130, 246, 0.2)', border: 'rgba(59, 130, 246, 0.5)', text: '#93c5fd', badge: 'rgba(59, 130, 246, 0.3)' },
                { bg: 'rgba(147, 51, 234, 0.2)', border: 'rgba(147, 51, 234, 0.5)', text: '#d8b4fe', badge: 'rgba(147, 51, 234, 0.3)' },
                { bg: 'rgba(16, 185, 129, 0.2)', border: 'rgba(16, 185, 129, 0.5)', text: '#6ee7b7', badge: 'rgba(16, 185, 129, 0.3)' },
                { bg: 'rgba(251, 146, 60, 0.2)', border: 'rgba(251, 146, 60, 0.5)', text: '#fdba74', badge: 'rgba(251, 146, 60, 0.3)' },
                { bg: 'rgba(236, 72, 153, 0.2)', border: 'rgba(236, 72, 153, 0.5)', text: '#f9a8d4', badge: 'rgba(236, 72, 153, 0.3)' },
                { bg: 'rgba(6, 182, 212, 0.2)', border: 'rgba(6, 182, 212, 0.5)', text: '#67e8f9', badge: 'rgba(6, 182, 212, 0.3)' }
            ];
            const emojis = ['1️⃣', '2️⃣', '3️⃣', '4️⃣', '5️⃣', '6️⃣'];
            
            container.innerHTML = priorities.slice(0, 6).map((priority, index) => {
                const scheme = colorSchemes[index % colorSchemes.length];
                const isCompleted = priority.completed || false;
                const checkmark = isCompleted ? '<i class="fas fa-check-circle text-green-400 ml-2"></i>' : '';
                
                return `
                    <div style="background: ${scheme.bg}; border: 1px solid ${scheme.border};" 
                         class="rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">${emojis[index]}</span>
                                <span class="font-bold" style="color: ${scheme.text}">${priority.title}${checkmark}</span>
                            </div>
                            <span class="text-xs px-2 py-1 rounded" style="background: ${scheme.badge}">${priority.category}</span>
                        </div>
                        <div class="text-sm text-gray-300 ml-10">${priority.description}</div>
                    </div>
                `;
            }).join('');
            
            // Update status
            const statusEl = document.getElementById('priority-status');
            if (statusEl) {
                const completed = priorities.filter(p => p.completed).length;
                const total = priorities.length;
                if (completed > 0) {
                    statusEl.innerHTML = `✓ ${completed} of ${total} priorities completed`;
                    statusEl.className = 'mt-4 text-sm text-green-400 text-center';
                } else {
                    statusEl.innerHTML = `Priorities for this day`;
                    statusEl.className = 'mt-4 text-sm text-gray-400 text-center';
                }
            }
            
            console.log('Priorities rendered successfully!', priorities.length, 'items');
        }

        function updatePriorityDayDisplay() {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            currentPriorityDate.setHours(0, 0, 0, 0);
            
            const displayEl = document.getElementById('priority-day-display');
            const nextBtn = document.getElementById('nextPriorityBtn');
            if (!displayEl) return;
            
            const isToday = currentPriorityDate.getTime() === today.getTime();
            const isTomorrow = currentPriorityDate.getTime() === (new Date(today.getTime() + 24*60*60*1000)).getTime();
            const isFuture = currentPriorityDate.getTime() > today.getTime();
            
            if (isToday) {
                displayEl.textContent = 'Today';
                displayEl.className = 'text-sm font-semibold text-blue-400';
            } else if (isTomorrow) {
                displayEl.textContent = 'Tomorrow';
                displayEl.className = 'text-sm font-semibold text-green-400';
            } else {
                const dayOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][currentPriorityDate.getDay()];
                displayEl.textContent = `${dayOfWeek}, ${monthNames[currentPriorityDate.getMonth()]} ${currentPriorityDate.getDate()}`;
                displayEl.className = 'text-sm font-semibold cursor-pointer hover:text-blue-400';
            }
            
            // Enable/disable next button based on whether we can go forward
            if (nextBtn) {
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                
                if (currentPriorityDate.getTime() >= tomorrow.getTime()) {
                    // Already at tomorrow or beyond - disable next
                    nextBtn.disabled = true;
                    nextBtn.className = 'text-sm text-gray-600 cursor-not-allowed';
                } else {
                    // Can go forward - enable next
                    nextBtn.disabled = false;
                    nextBtn.className = 'text-sm text-gray-400 hover:text-white';
                }
            }
        }

        function prevPriorityDay() {
            // Navigate to previous day
            const newDate = new Date(currentPriorityDate);
            newDate.setDate(newDate.getDate() - 1);
            currentPriorityDate = newDate;
            
            // Update calendar view to match
            currentYear = newDate.getFullYear();
            currentMonth = newDate.getMonth();
            renderCalendar();
            renderPriorities();
        }

        function nextPriorityDay() {
            // Navigate to next day (allow tomorrow but not beyond)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const newDate = new Date(currentPriorityDate);
            newDate.setDate(newDate.getDate() + 1);
            newDate.setHours(0, 0, 0, 0);
            
            // Allow going to tomorrow (today + 1 day)
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            if (newDate.getTime() <= tomorrow.getTime()) {
                currentPriorityDate = newDate;
                
                // Update calendar view to match
                currentYear = newDate.getFullYear();
                currentMonth = newDate.getMonth();
                renderCalendar();
                renderPriorities();
            }
        }

        function jumpPriorityToToday() {
            // Jump calendar to today, which will auto-sync priorities
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();
            renderCalendar();
            syncPriorityToCalendar();
        }

        function togglePriorityForDay(priorityId) {
            const dayData = PNLManager.getDay(
                currentPriorityDate.getFullYear(), 
                currentPriorityDate.getMonth(), 
                currentPriorityDate.getDate()
            );
            
            let prioritiesWorkedOn = dayData.prioritiesWorkedOn || [];
            
            if (prioritiesWorkedOn.includes(priorityId)) {
                // Remove it
                prioritiesWorkedOn = prioritiesWorkedOn.filter(id => id !== priorityId);
            } else {
                // Add it
                prioritiesWorkedOn.push(priorityId);
            }
            
            dayData.prioritiesWorkedOn = prioritiesWorkedOn;
            PNLManager.setDay(
                currentPriorityDate.getFullYear(), 
                currentPriorityDate.getMonth(), 
                currentPriorityDate.getDate(), 
                dayData
            );
            
            renderPriorities();
        }

        function openEditPrioritiesModal() {
            // Get the day data to see what priorities are already set for this day
            const dayData = PNLManager.getDay(
                currentPriorityDate.getFullYear(), 
                currentPriorityDate.getMonth(), 
                currentPriorityDate.getDate()
            );
            const dayPriorities = dayData.priorities || [];
            
            // Initialize the day priorities for this modal session
            editingPriorities = [...dayPriorities];
            
            const modal = document.createElement('div');
            modal.id = 'priorities-modal';
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 overflow-y-auto py-8';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 max-w-3xl w-full mx-4 border border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-white">
                            <i class="fas fa-star text-yellow-400 mr-2"></i>Manage Priorities for ${currentPriorityDate.toDateString()}
                        </h3>
                        <button onclick="closePrioritiesModal()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <button onclick="addNewPriority()" class="btn-primary w-full">
                            <i class="fas fa-plus mr-2"></i>Add New Priority
                        </button>
                    </div>
                    
                    <div id="priorities-edit-list" class="space-y-3 mb-6">
                        <!-- Priorities will be rendered here -->
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="savePriorities()" class="btn-primary flex-1">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                        <button onclick="closePrioritiesModal()" class="btn-primary bg-gray-600 hover:bg-gray-700">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            renderPrioritiesEditList();
        }

        let editingPriorities = [];

        function renderPrioritiesEditList() {
            const container = document.getElementById('priorities-edit-list');
            
            if (!container) {
                return;
            }
            
            if (editingPriorities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        No priorities for this day yet. Click "Add New Priority" to create one.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = editingPriorities.map((priority, index) => `
                <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600">
                    <div class="grid grid-cols-12 gap-3 items-center">
                        <div class="col-span-1 flex items-center justify-center">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" ${priority.completed ? 'checked' : ''} 
                                       onchange="updatePriority(${index}, 'completed', this.checked)"
                                       class="w-5 h-5">
                            </label>
                        </div>
                        <input type="text" value="${priority.title || ''}" 
                               placeholder="Priority Title (e.g., Man City vs Arsenal)"
                               oninput="updatePriority(${index}, 'title', this.value)"
                               class="input-field col-span-4 text-sm py-2">
                        <input type="text" value="${priority.category || ''}" 
                               placeholder="Category (e.g., EPL, NBA)"
                               oninput="updatePriority(${index}, 'category', this.value)"
                               class="input-field col-span-2 text-sm py-2">
                        <input type="text" value="${priority.description || ''}" 
                               placeholder="Description/Details"
                               oninput="updatePriority(${index}, 'description', this.value)"
                               class="input-field col-span-4 text-sm py-2">
                        <button onclick="removePriority(${index})" 
                                class="btn-primary bg-red-600 hover:bg-red-700 col-span-1 text-sm py-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        let selectedPriorityIds = [];

        function togglePrioritySelection(priorityId, isSelected) {
            if (isSelected) {
                if (!selectedPriorityIds.includes(priorityId)) {
                    selectedPriorityIds.push(priorityId);
                }
            } else {
                selectedPriorityIds = selectedPriorityIds.filter(id => id !== priorityId);
            }
            console.log('Updated selection:', selectedPriorityIds);
        }

        function addNewPriority() {
            editingPriorities.push({
                id: Date.now(),
                title: '',
                category: '',
                description: '',
                completed: false
            });
            renderPrioritiesEditList();
        }
        

        function updatePriority(index, field, value) {
            if (editingPriorities[index]) {
                editingPriorities[index][field] = value;
            }
        }

        function removePriority(index) {
            if (confirm('Remove this priority?')) {
                editingPriorities.splice(index, 1);
                renderPrioritiesEditList();
            }
        }

        function savePriorities() {
            try {
                // Save the day-specific priorities
            const dayData = PNLManager.getDay(
                currentPriorityDate.getFullYear(), 
                currentPriorityDate.getMonth(), 
                currentPriorityDate.getDate()
            );
                
                dayData.priorities = [...editingPriorities];
                
            PNLManager.setDay(
                currentPriorityDate.getFullYear(), 
                currentPriorityDate.getMonth(), 
                currentPriorityDate.getDate(), 
                dayData
            );
            
                // Save silently and close
            renderPriorities();
            closePrioritiesModal();
            } catch (error) {
                console.error('Error saving priorities:', error);
                // Still close the modal even if there's an error
                closePrioritiesModal();
            }
        }
        
        // Make functions globally accessible
        window.savePriorities = savePriorities;
        window.closePrioritiesModal = closePrioritiesModal;
        window.updatePriority = updatePriority;
        window.removePriority = removePriority;
        window.addNewPriority = addNewPriority;
        
        // Test data persistence
        function testDataPersistence() {
            console.log('Testing data persistence...');
            
            // Test saving priorities
            const testDate = new Date();
            const testPriorities = [
                { id: 1, title: 'Test Priority', category: 'Test', description: 'Test Description', completed: false }
            ];
            
            const dayData = PNLManager.getDay(testDate.getFullYear(), testDate.getMonth(), testDate.getDate());
            dayData.priorities = testPriorities;
            PNLManager.setDay(testDate.getFullYear(), testDate.getMonth(), testDate.getDate(), dayData);
            
            // Test loading priorities
            const loadedData = PNLManager.getDay(testDate.getFullYear(), testDate.getMonth(), testDate.getDate());
            console.log('Test priorities saved and loaded:', loadedData.priorities);
            
            // Test localStorage directly
            const rawData = localStorage.getItem('stevesystem_pnl_data');
            console.log('Raw localStorage data:', rawData);
            
            console.log('Data persistence test complete!');
        }
        
        // Run test on page load
        window.addEventListener('load', () => {
            console.log('PNL System loaded. All data is automatically saved to localStorage.');
            console.log('To test data persistence, run: testDataPersistence()');
        });

        function closePrioritiesModal() {
            const modal = document.getElementById('priorities-modal');
            if (modal) modal.remove();
        }

        function togglePriorityComplete(priorityId) {
            // This could mark priority as complete for the day
            console.log('Toggle priority:', priorityId);
        }

        // Single PNL Data Manager - The ONLY data controller
        class PNLDataManager {
            constructor() {
                this.data = null;
                this.isLoading = false;
                this.hasLoaded = false;
                this.storageKey = 'stevesystem_pnl_data';
            }

            async initialize() {
                if (this.isLoading || this.hasLoaded) {
                    console.log('⚠️ PNLDataManager already initialized, skipping...');
                    return;
                }
                
                this.isLoading = true;
                console.log('🚀 START: Loading data...');
                
                try {
                    // Load data ONCE
                    this.data = await this.loadData();
                    console.log('✅ SUCCESS: Data loaded', {
                        keys: Object.keys(this.data),
                        totalDays: Object.keys(this.data).length,
                        sampleData: Object.entries(this.data).slice(0, 3)
                    });
                    
                    // Process data ONCE
                    this.processData();
                    
                    // Render EVERYTHING ONCE
                    this.renderAll();
                    
                    this.hasLoaded = true;
                    this.removeLoadingBarrier();
                    
                } catch (error) {
                    console.error('❌ FAILED: Data loading failed', error);
                } finally {
                    this.isLoading = false;
                }
            }

            async loadData() {
                console.log('📡 Fetching from /api/data...');
                const response = await fetch('/api/data');
                if (!response.ok) throw new Error('API failed');
                const data = await response.json();
                
                // Also sync to localStorage as backup
                localStorage.setItem(this.storageKey, JSON.stringify(data));
                return data;
            }

            processData() {
                console.log('🔄 Processing data...');
                // Calculate EVERYTHING once
                this.totals = this.calculateTotals();
                this.monthlyData = this.calculateMonthlyData();
                this.chartData = this.prepareChartData();
                console.log('✅ Data processed - Total PNL:', this.totals);
            }

            calculateTotals() {
                return Object.values(this.data).reduce((sum, day) => sum + (day.pnl || 0), 0);
            }

            calculateMonthlyData() {
                // Calculate monthly data for calendar
                const monthlyData = {};
                Object.entries(this.data).forEach(([dateKey, dayData]) => {
                    monthlyData[dateKey] = {
                        pnl: dayData.pnl || 0,
                        trades: dayData.trades || 0,
                        priorities: dayData.priorities || []
                    };
                });
                return monthlyData;
            }

            prepareChartData() {
                // Prepare chart data for the current month
                const currentDate = new Date();
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const labels = [];
                const data = [];
                let runningTotal = 10000; // Starting capital
                
                console.log('🔄 Preparing chart data for month:', month + 1, year);
                console.log('📊 Available data keys:', Object.keys(this.data));
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const key = `${year}-${month + 1}-${day}`;
                    const dayData = this.data[key] || { pnl: 0 };
                    const date = new Date(year, month, day);
                    const dayOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()];
                    const monthDay = `${date.getMonth() + 1}/${date.getDate()}`;
                    
                    labels.push(`${dayOfWeek} ${monthDay}`);
                    
                    if (dayData.pnl) {
                        runningTotal += dayData.pnl;
                        console.log(`Day ${day}: PNL ${dayData.pnl}, Running Total: ${runningTotal}`);
                    }
                    data.push(runningTotal);
                }
                
                console.log('📊 Final chart data:', { labels: labels.slice(0, 5), data: data.slice(0, 5), finalTotal: runningTotal });
                return { labels, data, finalTotal: runningTotal };
            }

            renderAll() {
                console.log('🎨 Rendering complete dashboard...');
                
                // Initialize charts first
                this.initCharts();
                
                // Render everything with a small delay to ensure DOM is ready
                setTimeout(() => {
                    this.renderGraph();
                    this.renderCalendar(); 
                    this.renderTotals();
                    this.renderPriorities();
                    console.log('✅ Dashboard rendered completely');
                }, 100);
            }

            initCharts() {
                // Initialize capital chart
                if (!window.capitalChartInstance) {
                    const ctx = document.getElementById('capitalChart');
                    if (ctx) {
                        window.capitalChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: [{
                                    label: 'Capital',
                                    data: [],
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        grid: { color: '#374151' },
                                        ticks: { color: '#9ca3af' }
                                    },
                                    x: {
                                        grid: { color: '#374151' },
                                        ticks: { color: '#9ca3af' }
                                    }
                                }
                            }
                        });
                    }
                }
            }

            renderGraph() {
                if (!window.capitalChartInstance) return;
                
                const chartData = this.chartData;
                window.capitalChartInstance.data.labels = chartData.labels;
                window.capitalChartInstance.data.datasets[0].data = chartData.data;
                window.capitalChartInstance.update();
                
                // Update current capital display
                const capitalElement = document.getElementById('capital-value');
                if (capitalElement) {
                    capitalElement.textContent = '$' + chartData.finalTotal.toLocaleString();
                }
                
                console.log('📊 Graph rendered with total:', chartData.finalTotal);
            }

            renderCalendar() {
                console.log('📅 Rendering calendar with processed data...');
                
                // Get the calendar element (it's actually calendar-grid, not calendar)
                const calendarElement = document.getElementById('calendar-grid');
                if (!calendarElement) {
                    console.log('⚠️ Calendar grid element not found, retrying in 200ms...');
                    setTimeout(() => this.renderCalendar(), 200);
                    return;
                }
                
                // Use the existing renderCalendar function but ensure it has access to the data
                if (typeof window.renderCalendar === 'function') {
                    // Temporarily set the data in the global scope for the existing function
                    window.currentPNLData = this.data;
                    console.log('📅 Data set for calendar:', Object.keys(this.data).length, 'days');
                    window.renderCalendar();
                    console.log('📅 Calendar rendered using existing function with data');
                } else {
                    console.log('⚠️ renderCalendar function not found');
                }
            }

            renderPriorities() {
                // Use existing renderPriorities function
                if (typeof window.renderPriorities === 'function') {
                    window.renderPriorities();
                    console.log('⭐ Priorities rendered using existing function');
                } else {
                    console.log('⚠️ renderPriorities function not found');
                }
            }

            renderTotals() {
                // Render all totals
                console.log('💰 Totals rendered:', this.totals);
            }

            removeLoadingBarrier() {
                const barrier = document.getElementById('loading-barrier');
                if (barrier) {
                    barrier.style.display = 'none';
                    console.log('✅ Loading barrier removed');
                }
            }

            // Legacy compatibility methods
            async getDay(year, month, day) {
                const key = `${year}-${month + 1}-${day}`;
                return this.data[key] || { 
                    pnl: 0, 
                    trades: 0, 
                    notes: '', 
                    priorities: [],
                    individualTrades: [],
                    morningIntentions: '',
                    focusAreas: '',
                    eveningReflection: '',
                    learned: '',
                    patterns: '',
                    improvements: '',
                    winRate: 0,
                    largestWin: 0
                };
            }
            
            async setDay(year, month, day, dayData) {
                const key = `${year}-${month + 1}-${day}`;
                this.data[key] = dayData;
                return await this.saveData();
            }

            async saveData() {
                try {
                    const response = await fetch('/api/data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.data)
                    });
                    
                    if (response.ok) {
                        console.log('✅ Data saved to server');
                    }
                    
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    return true;
                } catch (error) {
                    console.error('❌ Save failed:', error);
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    return false;
                }
            }
        }

        // GLOBAL instance - only one data manager exists
        window.pnlManager = new PNLDataManager();
        
        // Make PNLManager compatible with existing code
        window.PNLManager = {
            async getDay(year, month, day) {
                return await window.pnlManager.getDay(year, month, day);
            },
            async setDay(year, month, day, dayData) {
                return await window.pnlManager.setDay(year, month, day, dayData);
            },
            async loadData() {
                return window.pnlManager.data || {};
            },
            async saveData(data) {
                window.pnlManager.data = data;
                return await window.pnlManager.saveData();
            }
        };

        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let currentViewDate = new Date(); // For daily capital navigation
        let currentPriorityDate = new Date(); // For priority day navigation

        function initPNLChart() {
            renderCalendar();
        }
        
        // Make functions globally accessible
        window.renderCalendar = function() {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const firstDayOfWeek = firstDay.getDay();
            
            console.log('📅 renderCalendar called with data:', window.currentPNLData ? 'available' : 'not available');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('current-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const calendarGrid = document.getElementById('calendar-grid');
            if (!calendarGrid) {
                console.error('❌ Calendar grid element not found!');
                return;
            }
            console.log('📅 Calendar grid found, clearing content...');
            calendarGrid.innerHTML = '';
            
            // Calculate monthly stats - only count days with actual trades
            let monthTotal = 0;
            let wins = 0;
            let losses = 0;
            let bestDay = 0;
            let bestDayNum = 0;
            let worstDay = 0;
            let worstDayNum = 0;
            let tradingDays = 0;
            let winningDaysTotal = 0;
            
            // Add empty cells for days before the 1st
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'p-3 rounded-lg';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Add calendar days
            const today = new Date();
            const isCurrentMonth = currentYear === today.getFullYear() && currentMonth === today.getMonth();
            
            console.log(`📅 Creating calendar for ${daysInMonth} days in month ${currentMonth + 1}/${currentYear}`);
            
            for (let day = 1; day <= daysInMonth; day++) {
                // Use data from PNLDataManager if available, otherwise fall back to PNLManager
                let dayData;
                if (window.currentPNLData) {
                    const key = `${currentYear}-${currentMonth + 1}-${day}`;
                    dayData = window.currentPNLData[key] || { pnl: 0, trades: 0 };
                    console.log(`Day ${day}: Using PNLDataManager data - PNL: ${dayData.pnl}`);
                } else {
                    dayData = PNLManager.getDay(currentYear, currentMonth, day);
                }
                const pnl = dayData.pnl || 0;
                const trades = dayData.trades || 0;
                const isToday = isCurrentMonth && day === today.getDate();
                
                // Only count days where you actually traded
                if (trades > 0 || pnl !== 0) {
                    tradingDays++;
                    monthTotal += pnl;
                    
                    if (pnl > 0) {
                        wins++;
                        winningDaysTotal += pnl;
                    }
                    if (pnl < 0) {
                        losses++;
                    }
                    if (pnl > bestDay) {
                        bestDay = pnl;
                        bestDayNum = day;
                    }
                    if (pnl < worstDay) {
                        worstDay = pnl;
                        worstDayNum = day;
                    }
                }
                
                const dayCell = document.createElement('div');
                console.log(`📅 Creating day cell ${day}: PNL=${pnl}, Trades=${trades}`);
                
                // Style based on PNL and today
                let bgColor = 'bg-gray-800';
                let textColor = 'text-gray-400';
                let borderStyle = '';
                
                if (isToday) {
                    bgColor = 'bg-blue-900/50';
                    textColor = 'text-blue-300';
                    borderStyle = 'border-2 border-blue-400';
                } else if (pnl > 0) {
                    bgColor = 'bg-green-900/30 border border-green-500/50';
                    textColor = 'text-green-400';
                } else if (pnl < 0) {
                    bgColor = 'bg-red-900/30 border border-red-500/50';
                    textColor = 'text-red-400';
                }
                
                dayCell.className = `p-3 rounded-lg ${bgColor} ${borderStyle} cursor-pointer hover:opacity-80 transition-all relative z-10`;
                dayCell.innerHTML = `
                    <div class="text-xs ${isToday ? 'text-blue-300 font-bold' : 'text-gray-400'} mb-1">
                        ${isToday ? 'TODAY' : day}
                    </div>
                    <div class="text-sm font-bold ${textColor}">${pnl >= 0 ? '+' : ''}$${pnl}</div>
                `;
                dayCell.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Calendar day clicked:', day, 'Month:', currentMonth, 'Year:', currentYear);
                    
                    // Sync priorities to this day when clicked
                    currentPriorityDate = new Date(currentYear, currentMonth, day);
                    console.log('Calendar day clicked:', currentPriorityDate.toDateString());
                    console.log('Syncing priorities to:', currentPriorityDate.toDateString());
                    renderPriorities();
                    // Then open the modal
                    openDayModal(day);
                };
                
                calendarGrid.appendChild(dayCell);
            }
            
            // Update monthly stats display with proper calculations
            const winRate = tradingDays > 0 ? Math.round((wins / tradingDays) * 100) : 0;
            const avgWin = wins > 0 ? Math.round(winningDaysTotal / wins) : 0;
            
            // Month Total
            const totalEl = document.querySelector('.dashboard-card .grid .text-center:nth-child(1) .text-3xl');
            if (totalEl) {
                totalEl.textContent = (monthTotal >= 0 ? '+' : '') + '$' + monthTotal.toFixed(2);
                totalEl.className = monthTotal >= 0 ? 'text-3xl font-bold text-green-400' : 'text-3xl font-bold text-red-400';
            }
            
            // Wins / Losses
            const wlEl = document.querySelector('.dashboard-card .grid .text-center:nth-child(2) .text-2xl');
            if (wlEl) {
                if (tradingDays === 0) {
                    wlEl.innerHTML = `<span class="text-gray-400">No trades yet</span>`;
                } else {
                    wlEl.innerHTML = `<span class="text-green-400">${wins}</span><span class="text-gray-500"> / </span><span class="text-red-400">${losses}</span>`;
                }
            }
            
            const wrEl = document.querySelector('.dashboard-card .grid .text-center:nth-child(2) .text-xs');
            if (wrEl) {
                wrEl.textContent = tradingDays > 0 ? `${winRate}% Win Rate` : 'Start tracking!';
            }
            
            // Avg Win
            const avgEl = document.querySelector('.dashboard-card .grid .text-center:nth-child(3) .text-2xl');
            if (avgEl) {
                avgEl.textContent = wins > 0 ? '$' + avgWin : '$0';
            }
            
            // Best Day
            const bestEl = document.querySelector('.dashboard-card .grid .text-center:nth-child(4) .text-2xl');
            const bestDateEl = document.querySelector('.dashboard-card .grid .text-center:nth-child(4) .text-xs');
            if (bestEl && bestDateEl) {
                if (bestDayNum > 0) {
                    bestEl.textContent = '$' + bestDay.toFixed(0);
                    bestDateEl.textContent = monthNames[currentMonth].slice(0, 3) + ' ' + bestDayNum;
                } else {
                    bestEl.textContent = '$0';
                    bestDateEl.textContent = 'No data';
                }
            }
        }

        async function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
            await updateCapitalChart(); // Update graph when month changes
            // Sync priorities to first day of new month view
            syncPriorityToCalendar();
        }

        async function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
            await updateCapitalChart(); // Update graph when month changes
            // Sync priorities to first day of new month view
            syncPriorityToCalendar();
        }
        
        function syncPriorityToCalendar() {
            // Sync priority panel to show the same date as calendar focus
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // If we're in the same month as today, show today
            if (currentYear === today.getFullYear() && currentMonth === today.getMonth()) {
                currentPriorityDate = new Date(today);
            } else {
                // Different month - show first day of that month
                currentPriorityDate = new Date(currentYear, currentMonth, 1);
            }
            renderPriorities();
        }

        let selectedDay = null;

        function openDayModal(day) {
            selectedDay = day;
            
            // Use data from PNLDataManager if available, otherwise fall back to PNLManager
            let dayData;
            if (window.currentPNLData) {
                const key = `${currentYear}-${currentMonth + 1}-${day}`;
                dayData = window.currentPNLData[key] || { 
                    pnl: 0, 
                    trades: 0, 
                    notes: '', 
                    priorities: [],
                    individualTrades: [],
                    morningIntentions: '',
                    focusAreas: '',
                    eveningReflection: '',
                    learned: '',
                    patterns: '',
                    improvements: '',
                    winRate: 0,
                    largestWin: 0
                };
                console.log('=== Opening Day Modal (PNLDataManager) ===');
            } else {
                dayData = PNLManager.getDay(currentYear, currentMonth, day);
                console.log('=== Opening Day Modal (PNLManager) ===');
            }
            
            console.log('Date:', currentYear, currentMonth + 1, day);
            console.log('Storage Key:', `${currentYear}-${currentMonth + 1}-${day}`);
            console.log('Day Data:', JSON.stringify(dayData, null, 2));
            console.log('Priorities worked on:', dayData.prioritiesWorkedOn);
            console.log('All localStorage data:', localStorage.getItem('stevesystem_pnl_data'));
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const weekDays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const date = new Date(currentYear, currentMonth, day);
            
            // Show comprehensive modal with form
            const modal = document.createElement('div');
            modal.id = 'pnl-modal';
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 overflow-y-auto py-8';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 max-w-4xl w-full mx-4 border border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-white">
                                ${weekDays[date.getDay()]}, ${monthNames[currentMonth]} ${day}, ${currentYear}
                            </h3>
                            <p class="text-sm text-gray-400">Complete Trading Journal</p>
                        </div>
                        <button onclick="closeDayModal()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Left Column -->
                        <div class="space-y-4">
                            <!-- Daily PNL & Stats -->
                            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                                <h4 class="text-lg font-bold text-blue-400 mb-3">📊 Daily Summary</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">Daily PNL ($)</label>
                                        <input type="number" id="modal-pnl" value="${dayData.pnl || 0}" 
                                               class="input-field w-full" step="0.01">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">Number of Trades</label>
                                        <input type="number" id="modal-trades" value="${dayData.trades || 0}" 
                                               class="input-field w-full">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">Win Rate (%)</label>
                                        <input type="number" id="modal-winrate" value="${dayData.winRate || 0}" 
                                               class="input-field w-full" min="0" max="100">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">Largest Win ($)</label>
                                        <input type="number" id="modal-largestwin" value="${dayData.largestWin || 0}" 
                                               class="input-field w-full" step="0.01">
                                    </div>
                                </div>
                            </div>

                            <!-- Morning Intentions -->
                            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                                <h4 class="text-lg font-bold text-yellow-400 mb-2">
                                    <i class="fas fa-sun mr-2"></i>Morning Intentions
                                </h4>
                                <p class="text-xs text-gray-400 mb-2">What would the billion-dollar version of me do today?</p>
                                <textarea id="modal-morning" class="input-field w-full h-20 text-sm"
                                          placeholder="My focus areas, goals, mindset for today...">${dayData.morningIntentions || ''}</textarea>
                            </div>

                            <!-- Key Focus Areas -->
                            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                                <h4 class="text-lg font-bold text-purple-400 mb-2">
                                    <i class="fas fa-bullseye mr-2"></i>Key Focus Areas
                                </h4>
                                <textarea id="modal-focus" class="input-field w-full h-16 text-sm"
                                          placeholder="What are the 2-3 most important things today?">${dayData.focusAreas || ''}</textarea>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="space-y-4">
                            <!-- Evening Reflection -->
                            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                                <h4 class="text-lg font-bold text-orange-400 mb-2">
                                    <i class="fas fa-moon mr-2"></i>Evening Reflection
                                </h4>
                                <p class="text-xs text-gray-400 mb-2">Did I trade long-game EV or ego/boredom?</p>
                                <textarea id="modal-evening" class="input-field w-full h-20 text-sm"
                                          placeholder="Honest reflection on today's decisions...">${dayData.eveningReflection || ''}</textarea>
                            </div>

                            <!-- What I Learned -->
                            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                                <h4 class="text-lg font-bold text-green-400 mb-2">
                                    <i class="fas fa-lightbulb mr-2"></i>What I Learned Today
                                </h4>
                                <textarea id="modal-learned" class="input-field w-full h-20 text-sm"
                                          placeholder="Key insights and lessons...">${dayData.learned || ''}</textarea>
                            </div>

                            <!-- Patterns Caught -->
                            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                                <h4 class="text-lg font-bold text-cyan-400 mb-2">
                                    <i class="fas fa-chart-line mr-2"></i>Patterns Caught
                                </h4>
                                <textarea id="modal-patterns" class="input-field w-full h-16 text-sm"
                                          placeholder="Market patterns, edge opportunities spotted...">${dayData.patterns || ''}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Individual Trades Table -->
                    <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700 mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-bold text-blue-400">
                                <i class="fas fa-list mr-2"></i>Individual Trades
                            </h4>
                            <button onclick="addTradeRow()" class="btn-primary text-sm">
                                <i class="fas fa-plus mr-1"></i>Add Trade
                            </button>
                        </div>
                        <div id="trades-container" class="space-y-2">
                            <!-- Trades will be populated here -->
                        </div>
                    </div>

                    <!-- Priorities Worked On Today -->
                    <div class="bg-yellow-900/20 rounded-lg p-4 border border-yellow-500/50 mb-6">
                        <h4 class="text-lg font-bold text-yellow-400 mb-2">
                            <i class="fas fa-star mr-2"></i>Priorities Worked On Today
                        </h4>
                        <div id="priority-checkboxes" class="grid grid-cols-2 gap-2">
                            <!-- Priority checkboxes will be rendered here -->
                        </div>
                    </div>

                    <!-- What Could've Been Better -->
                    <div class="bg-red-900/20 rounded-lg p-4 border border-red-500/50 mb-6">
                        <h4 class="text-lg font-bold text-red-400 mb-2">
                            <i class="fas fa-exclamation-triangle mr-2"></i>What Could've Been Better
                        </h4>
                        <textarea id="modal-improvements" class="input-field w-full h-16 text-sm"
                                  placeholder="Mistakes, areas for improvement, what not to do again...">${dayData.improvements || ''}</textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button onclick="saveDayData()" class="btn-primary flex-1">
                            <i class="fas fa-save mr-2"></i>Save Daily Data
                        </button>
                        <button onclick="clearDayData()" class="btn-primary bg-red-600 hover:bg-red-700">
                            <i class="fas fa-trash mr-2"></i>Clear
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Populate trades
            renderTrades(dayData.individualTrades || []);
            
            // Populate priority checkboxes
            renderPriorityCheckboxes(dayData.priorities || []);
        }

        function renderPriorityCheckboxes(dayPriorities = []) {
            const container = document.getElementById('priority-checkboxes');
            if (!container) {
                console.error('Priority checkboxes container not found');
                return;
            }

            console.log('=== Rendering Priority Checkboxes (day-specific) ===');
            console.log('Priorities for this day:', dayPriorities);

            if (dayPriorities.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 text-center py-2 text-gray-400 text-sm">
                        No priorities for this day.
                    </div>
                `;
                return;
            }

            container.innerHTML = dayPriorities.map(priority => {
                return `
                    <label class="flex items-center space-x-2 p-3 bg-gray-700/50 rounded">
                        <input type="checkbox" value="${priority.id}" ${priority.completed ? 'checked' : ''} class="priority-checkbox w-4 h-4">
                        <span class="text-sm text-white">${priority.title} <span class="text-gray-400">(${priority.category})</span></span>
                    </label>
                `;
            }).join('');
        }

        function closeDayModal() {
            const modal = document.getElementById('pnl-modal');
            if (modal) modal.remove();
        }

        let currentTrades = [];

        function renderTrades(trades) {
            currentTrades = trades || [];
            const container = document.getElementById('trades-container');
            
            if (currentTrades.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-400 text-sm">
                        No trades added yet. Click "Add Trade" to get started.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentTrades.map((trade, index) => `
                <div class="bg-gray-700/50 rounded p-3 grid grid-cols-12 gap-2 items-center">
                    <input type="text" value="${trade.match || ''}" placeholder="Match/Event" 
                           class="input-field col-span-3 text-sm py-1" onchange="updateTrade(${index}, 'match', this.value)">
                    <input type="text" value="${trade.bet || ''}" placeholder="Bet Type" 
                           class="input-field col-span-3 text-sm py-1" onchange="updateTrade(${index}, 'bet', this.value)">
                    <input type="number" value="${trade.odds || ''}" placeholder="Odds" 
                           class="input-field col-span-1 text-sm py-1" step="0.01" onchange="updateTrade(${index}, 'odds', this.value)">
                    <input type="number" value="${trade.stake || ''}" placeholder="Stake" 
                           class="input-field col-span-1 text-sm py-1" onchange="updateTrade(${index}, 'stake', this.value)">
                    <select class="input-field col-span-2 text-sm py-1" onchange="updateTrade(${index}, 'result', this.value)">
                        <option value="pending" ${trade.result === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="won" ${trade.result === 'won' ? 'selected' : ''}>Won</option>
                        <option value="lost" ${trade.result === 'lost' ? 'selected' : ''}>Lost</option>
                        <option value="push" ${trade.result === 'push' ? 'selected' : ''}>Push</option>
                    </select>
                    <input type="number" value="${trade.pnl || 0}" placeholder="PNL" 
                           class="input-field col-span-1 text-sm py-1" step="0.01" onchange="updateTrade(${index}, 'pnl', this.value)">
                    <button onclick="removeTrade(${index})" class="btn-primary bg-red-600 hover:bg-red-700 col-span-1 text-sm py-1">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function addTradeRow() {
            currentTrades.push({
                match: '',
                bet: '',
                odds: 0,
                stake: 0,
                result: 'pending',
                pnl: 0
            });
            renderTrades(currentTrades);
        }

        function updateTrade(index, field, value) {
            currentTrades[index][field] = field === 'odds' || field === 'stake' || field === 'pnl' 
                ? parseFloat(value) || 0 
                : value;
            
            // Auto-calculate PNL if result is set
            const trade = currentTrades[index];
            if (trade.result === 'won' && trade.odds && trade.stake) {
                trade.pnl = (trade.odds - 1) * trade.stake;
            } else if (trade.result === 'lost' && trade.stake) {
                trade.pnl = -trade.stake;
            } else if (trade.result === 'push') {
                trade.pnl = 0;
            }
            
            renderTrades(currentTrades);
        }

        function removeTrade(index) {
            if (confirm('Remove this trade?')) {
                currentTrades.splice(index, 1);
                renderTrades(currentTrades);
            }
        }

        function saveDayData() {
            try {
                // Get the current day's data from PNLDataManager if available
                let dayData;
                if (window.currentPNLData) {
                    const key = `${currentYear}-${currentMonth + 1}-${selectedDay}`;
                    dayData = window.currentPNLData[key] || { 
                        pnl: 0, 
                        trades: 0, 
                        notes: '', 
                        priorities: [],
                        individualTrades: [],
                        morningIntentions: '',
                        focusAreas: '',
                        eveningReflection: '',
                        learned: '',
                        patterns: '',
                        improvements: '',
                        winRate: 0,
                        largestWin: 0
                    };
                } else {
                    dayData = PNLManager.getDay(currentYear, currentMonth, selectedDay);
                }
                const currentPriorities = dayData.priorities || [];
                
                // Update completion status based on checkboxes
                const priorityCheckboxes = document.querySelectorAll('.priority-checkbox');
                priorityCheckboxes.forEach(checkbox => {
                    const priorityId = parseInt(checkbox.value);
                    const priority = currentPriorities.find(p => p.id === priorityId);
                    if (priority) {
                        priority.completed = checkbox.checked;
                    }
                });
            
            console.log('=== Saving Day Data ===');
            console.log('Date:', currentYear, currentMonth + 1, selectedDay);
                console.log('Updated priorities:', currentPriorities);
            
            // Collect all data from the comprehensive form
                const updatedDayData = {
                pnl: parseFloat(document.getElementById('modal-pnl').value) || 0,
                trades: parseInt(document.getElementById('modal-trades').value) || 0,
                winRate: parseFloat(document.getElementById('modal-winrate').value) || 0,
                largestWin: parseFloat(document.getElementById('modal-largestwin').value) || 0,
                morningIntentions: document.getElementById('modal-morning').value || '',
                focusAreas: document.getElementById('modal-focus').value || '',
                eveningReflection: document.getElementById('modal-evening').value || '',
                learned: document.getElementById('modal-learned').value || '',
                patterns: document.getElementById('modal-patterns').value || '',
                improvements: document.getElementById('modal-improvements').value || '',
                individualTrades: currentTrades,
                    priorities: currentPriorities
            };
            
                console.log('Full day data being saved:', updatedDayData);
                
                // Save to PNLDataManager if available, otherwise fall back to PNLManager
                if (window.currentPNLData && window.pnlManager) {
                    const key = `${currentYear}-${currentMonth + 1}-${selectedDay}`;
                    window.currentPNLData[key] = updatedDayData;
                    window.pnlManager.data = window.currentPNLData;
                    window.pnlManager.saveData();
                    console.log('✅ Saved to PNLDataManager');
                } else {
                    PNLManager.setDay(currentYear, currentMonth, selectedDay, updatedDayData);
                    console.log('✅ Saved to PNLManager');
                }
                
            renderCalendar();
            closeDayModal();
            alert('Day data saved successfully!');
            } catch (error) {
                console.error('Error saving day data:', error);
                alert('Error saving data: ' + error.message);
            }
        }

        function clearDayData() {
            if (confirm('Clear all data for this day?')) {
                PNLManager.setDay(currentYear, currentMonth, selectedDay, { pnl: 0, trades: 0, notes: '' });
                renderCalendar();
                closeDayModal();
            }
        }

        // Bet Slip Import/Export Functions
        function showImportModal() {
            const modal = document.createElement('div');
            modal.id = 'import-modal';
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 max-w-2xl w-full mx-4 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-white">Import Bet Slips</h3>
                        <button onclick="closeImportModal()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Paste JSON Bet Slips</label>
                            <textarea id="import-json" class="input-field w-full h-64 font-mono text-sm"
                                placeholder='[
  {
    "date": "2025-10-15",
    "match": "Man City vs Arsenal", 
    "bet": "Under 2.5 Goals",
    "odds": 2.10,
    "stake": 100,
    "result": "won",
    "pnl": 110
  }
]'></textarea>
                        </div>
                        <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-3 text-sm">
                            <strong class="text-blue-300">Format:</strong>
                            <ul class="mt-2 space-y-1 text-gray-300">
                                <li>• <strong>date</strong>: YYYY-MM-DD format</li>
                                <li>• <strong>pnl</strong>: Profit/Loss (positive for wins, negative for losses)</li>
                                <li>• <strong>result</strong>: "won" or "lost"</li>
                                <li>• Optional: match, bet, odds, stake for notes</li>
                            </ul>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="importBetSlips()" class="btn-primary flex-1">
                                <i class="fas fa-upload mr-2"></i>Import
                            </button>
                            <button onclick="showSampleFormat()" class="btn-primary bg-gray-600 hover:bg-gray-700">
                                <i class="fas fa-info-circle mr-2"></i>Sample Format
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeImportModal() {
            const modal = document.getElementById('import-modal');
            if (modal) modal.remove();
        }

        function importBetSlips() {
            const jsonText = document.getElementById('import-json').value;
            
            try {
                const betSlips = JSON.parse(jsonText);
                
                if (!Array.isArray(betSlips)) {
                    alert('Error: JSON must be an array of bet slips');
                    return;
                }
                
                let imported = 0;
                let skipped = 0;
                
                betSlips.forEach(slip => {
                    if (!slip.date || !slip.pnl) {
                        skipped++;
                        return;
                    }
                    
                    const date = new Date(slip.date);
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const day = date.getDate();
                    
                    // Get existing day data
                    const existingData = PNLManager.getDay(year, month, day);
                    
                    // Build notes from bet slip details
                    let notes = existingData.notes || '';
                    if (slip.match) notes += `${slip.match}: `;
                    if (slip.bet) notes += `${slip.bet} `;
                    if (slip.odds) notes += `@ ${slip.odds} `;
                    if (slip.result) notes += `(${slip.result}) `;
                    notes += `$${slip.pnl}\n`;
                    
                    // Update or create day data
                    PNLManager.setDay(year, month, day, {
                        pnl: (existingData.pnl || 0) + parseFloat(slip.pnl),
                        trades: (existingData.trades || 0) + 1,
                        notes: notes.trim()
                    });
                    
                    imported++;
                });
                
                renderCalendar();
                closeImportModal();
                alert(`Import complete!\n\nImported: ${imported} bet slips\nSkipped: ${skipped}`);
                
            } catch (error) {
                alert('Error parsing JSON: ' + error.message);
            }
        }

        function showSampleFormat() {
            const sample = [
                {
                    "date": "2025-10-15",
                    "match": "Man City vs Arsenal",
                    "bet": "Under 2.5 Goals",
                    "odds": 2.10,
                    "stake": 100,
                    "result": "won",
                    "pnl": 110
                },
                {
                    "date": "2025-10-15",
                    "match": "Lakers vs Warriors",
                    "bet": "LeBron Over 27.5 pts",
                    "odds": 1.90,
                    "stake": 150,
                    "result": "lost",
                    "pnl": -150
                }
            ];
            
            document.getElementById('import-json').value = JSON.stringify(sample, null, 2);
        }

        function exportData() {
            const data = PNLManager.loadData();
            const jsonStr = JSON.stringify(data, null, 2);
            
            // Create download link
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stevesystem_pnl_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('PNL data exported successfully!');
        }

        function generateVoices() {
            alert('Generating Skitz voices...');
        }

        function openDashboard() {
            window.open('trading_dashboard/dashboard.html', '_blank');
        }

        // Debug function to view all stored data
        function debugShowAllData() {
            const pnlData = PNLManager.loadData();
            
            console.clear();
            console.log('========================================');
            console.log('ALL STORED PNL DATA (including day-specific priorities):');
            console.log('========================================');
            console.log(JSON.stringify(pnlData, null, 2));
            console.log('');
            console.log('========================================');
            console.log('SUMMARY:');
            console.log('========================================');
            
            // Count days with data
            const daysWithData = Object.keys(pnlData).length;
            console.log(`Days with data: ${daysWithData}`);
            
            // Count total priorities across all days
            let totalPriorities = 0;
            Object.values(pnlData).forEach(dayData => {
                if (dayData.priorities) {
                    totalPriorities += dayData.priorities.length;
                }
            });
            console.log(`Total priorities across all days: ${totalPriorities}`);
            
            // Count total trades
            let totalTrades = 0;
            Object.values(pnlData).forEach(dayData => {
                if (dayData.individualTrades) {
                    totalTrades += dayData.individualTrades.length;
                }
            });
            console.log(`Total individual trades: ${totalTrades}`);
            
            console.log('========================================');
            
            // Create a visual modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 overflow-y-auto py-8';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 max-w-4xl w-full mx-4 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-white">🐛 Debug: All Stored Data</h3>
                        <button onclick="this.closest('div.fixed').remove()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <div>
                            <h4 class="text-lg font-semibold text-white mb-2">PNL Data by Day:</h4>
                            <pre class="bg-gray-900 p-4 rounded text-xs text-green-400 overflow-x-auto">${JSON.stringify(pnlData, null, 2)}</pre>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-white mb-2">Priorities:</h4>
                            <pre class="bg-gray-900 p-4 rounded text-xs text-blue-400 overflow-x-auto">${JSON.stringify(priorities, null, 2)}</pre>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button onclick="this.closest('div.fixed').remove()" class="btn-primary">Close</button>
                        <button onclick="if(confirm('Clear ALL data?')) { localStorage.clear(); location.reload(); }" class="btn-primary bg-red-600 hover:bg-red-700">
                            Clear All Data
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html> 