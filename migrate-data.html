<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Migration Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">üîÑ Data Migration Tool</h1>
        
        <div class="space-y-6">
            <div class="bg-yellow-900/20 border border-yellow-500 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4 text-yellow-400">‚ö†Ô∏è Data Recovery</h2>
                <p class="text-gray-300 mb-4">
                    Your old data is still in localStorage! This tool will help you migrate it to the new file-based system.
                </p>
                <button onclick="checkOldData()" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded">
                    Check for Old Data
                </button>
            </div>
            
            <div id="data-status" class="hidden">
                <!-- Status will be shown here -->
            </div>
            
            <div id="migration-controls" class="hidden">
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold mb-4">Migration Options</h3>
                    <div class="space-y-4">
                        <button onclick="migrateToServer()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded mr-4">
                            Migrate to Server
                        </button>
                        <button onclick="downloadBackup()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                            Download Backup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let oldData = null;
        
        function checkOldData() {
            const statusDiv = document.getElementById('data-status');
            const controlsDiv = document.getElementById('migration-controls');
            
            try {
                // Check for old localStorage data
                const pnlData = localStorage.getItem('stevesystem_pnl_data');
                const prioritiesData = localStorage.getItem('stevesystem_priorities');
                
                if (pnlData || prioritiesData) {
                    oldData = {
                        pnl: pnlData ? JSON.parse(pnlData) : {},
                        priorities: prioritiesData ? JSON.parse(prioritiesData) : []
                    };
                    
                    const daysCount = Object.keys(oldData.pnl).length;
                    const prioritiesCount = oldData.priorities.length;
                    
                    statusDiv.innerHTML = `
                        <div class="bg-green-900/20 border border-green-500 p-6 rounded-lg">
                            <h3 class="text-lg font-bold text-green-400 mb-4">‚úÖ Old Data Found!</h3>
                            <div class="space-y-2 text-gray-300">
                                <p><strong>PNL Data:</strong> ${daysCount} days of data</p>
                                <p><strong>Priorities:</strong> ${prioritiesCount} global priorities</p>
                                <p class="text-sm text-gray-400">Your data is safe and can be migrated!</p>
                            </div>
                        </div>
                    `;
                    
                    controlsDiv.classList.remove('hidden');
                } else {
                    statusDiv.innerHTML = `
                        <div class="bg-red-900/20 border border-red-500 p-6 rounded-lg">
                            <h3 class="text-lg font-bold text-red-400 mb-4">‚ùå No Old Data Found</h3>
                            <p class="text-gray-300">No data found in localStorage. Either it was already migrated or never existed.</p>
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="bg-red-900/20 border border-red-500 p-6 rounded-lg">
                        <h3 class="text-lg font-bold text-red-400 mb-4">‚ùå Error</h3>
                        <p class="text-gray-300">Error checking for old data: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function migrateToServer() {
            if (!oldData) {
                alert('No data to migrate!');
                return;
            }
            
            try {
                // Convert old data format to new format
                const newData = { ...oldData.pnl };
                
                // Migrate global priorities to day-specific priorities
                if (oldData.priorities && oldData.priorities.length > 0) {
                    // For each day that has prioritiesWorkedOn, convert to new format
                    Object.keys(newData).forEach(dayKey => {
                        const dayData = newData[dayKey];
                        if (dayData.prioritiesWorkedOn && !dayData.priorities) {
                            // Convert old prioritiesWorkedOn to new priorities format
                            dayData.priorities = oldData.priorities
                                .filter(p => dayData.prioritiesWorkedOn.includes(p.id))
                                .map(p => ({
                                    ...p,
                                    completed: dayData.prioritiesWorkedOn.includes(p.id)
                                }));
                            delete dayData.prioritiesWorkedOn; // Remove old field
                        }
                    });
                }
                
                // Send to server
                const response = await fetch('/api/pnl-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ Data migrated successfully! ${result.message}`);
                    
                    // Clear old localStorage data
                    localStorage.removeItem('stevesystem_pnl_data');
                    localStorage.removeItem('stevesystem_priorities');
                    
                    // Refresh the page to show migrated data
                    window.location.href = '/';
                } else {
                    throw new Error('Failed to save to server');
                }
            } catch (error) {
                console.error('Migration error:', error);
                alert(`‚ùå Migration failed: ${error.message}`);
            }
        }
        
        function downloadBackup() {
            if (!oldData) {
                alert('No data to backup!');
                return;
            }
            
            const backup = {
                timestamp: new Date().toISOString(),
                pnlData: oldData.pnl,
                priorities: oldData.priorities
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pnl-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
